# Проект 7-го спринта

### Описание
Репозиторий предназначен для сдачи проекта 7-го спринта

### Структура хранилища 

Хранилище реализовано на основе пользовательской директории. При развертывании в продакшен имя пользовательской директории меняется на "prod"

- /user/master/data/geo/events - сырые входные данные по событиям (parquet) партиционированы по дате

- /user/yurgen001/data/snapshots/geo_city - справочник по координатам городов Австралии (csv), исходный формат оставлен без изменений

- /user/yurgen001/data/geo/events -  ODS слой таблица событий, партиционирована по дате и типу события (parquet)

- /user/yurgen001/data/analytics - директория для аналитиков, содержит выходные витрины в формате parquet

### График расчета витрин

В учебном проекте расчет все трех витрин реализован одновременно. Это позволяет один раз загрузить исходные данные и сделать общие предварительные вычисления. Данные обновляются раз в сутки после полуночи. Расчет производится с даты предыдущего дня на заданную глубину (в примере 60 дней). 

В реальной работе имеет  смысл выделить отдельно расчет витрины по зонам и расчитывать ее еженедельно и ежемесячно. 

### Некоторые пояснения по реализации 

При вычислении локального времени для пользователя время расчитано по Сиднею (рекомендация преподавателя)
```
FROM_UTC_TIMESTAMP(message_dt, CONCAT('Australia/', 'Sydney')) AS local_time
```
поскольку для многих городов Австралии нет данных по time zone ID и функция FROM_UTC_TIMESTAMP падает с ошибкой.


В качестве домашнего города, выбирается последний город, в котором пользователь непрерывно пробыл не менее 27 дней. Все сообщения пользователя при этом отправляются только из этого города. Это позволяет учесть пользователей, отправляющих сообщения не каждый день. 


В витрине по зонам в качестве номера недели выбран номер недели в месяце 
```
withColumn("week", F.expr("FLOOR(DAYOFMONTH(event_date) / 7) + 1"))
```

В ноутбуке с предварительными расчетами есть вариант расчета по неделям в году, но тогда надо делать две отдельные витрины по месяцам и по неделям. Их объединение, на мой взгляд, бессмысленно. 

Скрипты, реализующие джобы, продублированы в директорию /src/dags, чтобы не возиться с относительными путями.


